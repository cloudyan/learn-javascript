# 日志上报

为了监控前端应用是否正常运行，通常会在前端收集错误与性能等数据，最终将这些数据上报到服务端。因为日志上报并不是应用的主要功能逻辑，优先级比较低，所以我们在确保日志数据上报更高效的同时，还应该考虑如何尽可能地减少与其他关键操作的资源争抢。

在不影响用户路由切换和阻塞用户的情况下丢包率可以控制在 10%-30%，具体要看用户群体对应的环境

## sendBeacon

navigator.sendBeacon() 方法主要用于满足统计和诊断代码的需要。这些代码通常会在卸载文档之前，尝试通过 HTTP 将少量数据异步传输到 Web 服务器。它解决了日志上报在 unload 时成功率很低的问题。我们在埋点时有很多对离开页面时上报的需求，因为 SendBeacon 是异步的，不会影响当前页到下一个页面的跳转速度，可以更可靠地保障事件上报成功率，并且不影响路由切换。

```js
window.navigator.sendBeacon('上报事件的api', '数据参数')
```

## img.src

当浏览器不支持 navigator.sendBeacon 时，我们可以采用模拟图片加载的方式发送日志上报事件，且不会存在跨域问题。

```js
var img = new Image();
img.src = API + '?' + '数据参数'
```

## XmlHttpRequest

这里不推荐用 XmlHttpRequest。XHR 虽然支持异步请求，直接发送数据到后端，但是会受到跨域和同源的限制。而通过日志上报 API 跟业务是不在一个域下的，如果采用这种模式需要设置 Access-Control-Allow-Origin:* 跨域，非常不方便，并且在 unload 情况下上报发生的丢包率最高。

总结来看，日志上报推荐采用 sendBeacon -> img.src。在不影响用户路由切换和阻塞用户的情况下丢包率可以控制在 10%-30%，具体要看用户群体对应的环境。

